アプリ要件定義書
1. アプリ概要
アプリ名: 禁煙30日チャレンジ

目的: ユーザーが30日間の禁煙チャレンジを通じて、禁煙を習慣化し、成功体験を得ることを支援する。金銭的なインセンティブとゲーム性（ナラティブ）を組み合わせることで、ユーザーのモチベーション維持を図る。達成率に応じた返金を通じて、ユーザーが禁煙の成功を実感できるようにする。

ターゲットユーザー: 禁煙を考えている喫煙者、または過去に禁煙に挫折した経験がある方。金銭的なモチベーションが有効で、ゲーム感覚で楽しみながら禁煙に取り組みたい方。

2. ナラティブ（ストーリー）
コアコンセプト:
タバコの煙から生まれた悪しき存在「マネーモンスター」があなたのお金を奪っている！毎日の記録でマネーモンスターにダメージを与え、お金を取り戻そう！

ストーリー設定:
「あなたが今まで使ったタバコ代は、実は『マネーモンスター』に奪われていたのです。この怪物は、あなたのお金と健康を日々食い荒らしています。でも大丈夫！このアプリで毎日記録をつけることで、マネーモンスターを退治し、お金を取り戻すことができます！」

ゲームの流れ:

1. 初日の設定:
参加費がマネーモンスターの体力として表示されます。
「このマネーモンスターが、あなたから奪った〇〇円を持っています。さあ、退治してお金を取り戻しましょう！」

2. 毎日の記録:

禁煙成功の場合:
「大ダメージ！〇〇円を取り戻しました！マネーモンスターが弱っています！」
マネーモンスターの体力ゲージが大きく減り、取り戻した金額が増加。

喫煙してしまった場合:
「今日は吸ってしまいましたが、記録することが大切です！記録を続けることで確実にダメージを与えられます！」
マネーモンスターの体力ゲージが減り、取り戻した金額が増加。（記録すれば成功日としてカウント）

3. 進捗画面:
マネーモンスターが持っている袋の中のお金が、取り戻すたびに減っていく演出。
- マネーモンスターの体力は「現在の体力/最大体力」の形式で表示（例：¥8,000 / ¥10,000）
- 最大体力は初期の参加費、現在の体力は残りの金額として表示
- 「取り戻した金額」と「まだ奪われている金額」が一目で分かる表示。

4. 30日達成:
「完全勝利！マネーモンスターを倒し、お金と健康を取り戻しました！あなたは禁煙チャレンジの勝者です！」

3. 主要機能
3.1. ログイン・認証機能
認証方法:

メールアドレス・パスワード認証: Supabase Authを使用した標準的な認証

UI: ログイン画面に「ログイン」「新規アカウント作成」のボタンを配置し、ユーザーにとってわかりやすい形で実装

セキュリティ: Supabase Authの認証機能を使用し、セッション管理を適切に実装

3.2. オンボーディング（アプリ初回起動時）
ゲームルール説明:

ゲームの基本コンセプト説明:
「禁煙30日チャレンジは、あなたのお金を奪う『マネーモンスター』を倒すゲームです！」

ルール説明（簡潔に）:
- 毎日記録をつけるだけで、マネーモンスターにダメージを与えられます
- 禁煙できた日も、吸ってしまった日も、記録すれば成功日としてカウントされます
- 30日間の記録に応じて、お金を取り戻すことができます

返金プラン選択:
ユーザーは以下の3つの返金プランから1つを選択できます：

**初級プラン（MVP）**:
- 概要: 現在の返金システムをそのまま適用する
- 返金計算ロジック: 参加費 × 記録成功日数 ÷ 30日
- 特徴: 最も基本的なプラン
- 返金計算ロジックの具体例:
  - 参加費10,000円、20日記録成功した場合 → 10,000円 × 20 ÷ 30 = 6,667円が返金
  - 参加費0円、20日記録成功した場合 → 0円が返金
- 重要なルール:
  - 毎日記録をつけることで「記録成功日数」としてカウントされます
  - 禁煙できた日も、吸ってしまった日も、記録すれば成功日としてカウントされます
  - 30日間毎日記録をつけた場合：満額（参加費の全額）が返金されます
  - チャレンジの途中放棄も可能ですが、参加費の返金はありません

**中級プラン（今後の実装予定）**:
- 概要: ユーザーの禁煙成功日数に応じて返金額が変動する
- 返金計算ロジック: 参加費 × 禁煙成功日 / 30日
- 特徴: 禁煙努力が直接返金額に反映される
- 「禁煙成功日」の定義: 中級プランにおける「禁煙成功日」は、喫煙を記録しなかった日数を指します

**上級プラン（今後の実装予定）**:
- 概要: 毎日の禁煙記録が厳密に管理され、一度でも失敗すると返金対象外となる
- 返金計算ロジック:
  - 毎日禁煙記録を達成した場合: 満額（参加費の全額）が返金される
  - 一度でも喫煙を記録した場合、または未記録のまま次の日が到来した場合: その時点でゲームオーバーとなり、返金は行われない
- 特徴: 高い禁煙意欲を持つユーザー向け。厳格なルールにより禁煙達成を強力にサポート
- 「未記録」の定義: 上級プランにおける「未記録」は、特定の日の喫煙状況が記録されずに次の日が始まった時点を指します

参加費とリターンの説明:
- 最初に参加費を設定します（月のタバコ代が目安）
- 記録日数に応じて、参加費の一部が返金されます
- 返金額は参加費と記録日数に基づいて計算されます

UI: イラストやアニメーションを使って、マネーモンスターのビジュアルとともに説明。各プランの詳細説明とリスクを分かりやすく表示

喫煙状況のヒアリング:

質問: 「（期間）に（）箱」

UI: 期間選択（「1日」「1週間」「1ヶ月」のプルダウン）と、箱数選択（「1/2箱」～「10箱」のプルダウン）。

参加費の提示と設定:

喫煙状況と1箱500円（仮定）を基に月額タバコ代を算出。

算出した月額タバコ代を「デフォルトの参加費」として提示。

四捨五入ルール: 10の位で四捨五入し、100の位までの切りのいい数字にする。

UI: 算出された推奨参加費がデフォルトで選択された状態のプルダウンを表示。推奨金額が選択肢にない場合は自動的に追加される。プルダウンには0円から50,000円までの主要な選択肢を用意し、推奨金額には「(推奨)」マークを表示。0円での参加も可能。





記録時間の指定:

UI: 毎日記録する時間をユーザーが設定できる時間選択ピッカー（例: 20:00）。

機能: 設定した時間に記録を促すプッシュ通知を送るための仕組みと連携。

3.3. 毎日の記録機能（30日間チャレンジ）
質問1: 「今日煙草を吸いましたか？」

UI: 「はい」「いいえ」のラジオボタン。

「いいえ」（禁煙成功）の場合:

表示メッセージ: 「素晴らしい！禁煙成功です。明日も頑張ってください！」

処理: 記録成功日として記録。マネーモンスターに「大ダメージ」を与える演出と、取り戻し予定額の増加。

「はい」（喫煙してしまった）の場合:

表示メッセージ: 「今日はタバコを吸ってしまいましたが、勇気を出して記録したことが重要です！記録を続けることこそが、成功への道筋です。明日も記録を続けましょう！」

処理: 記録成功日として記録。記録することでマネーモンスターに「ダメージ」を与える演出と、取り戻し予定額の増加。

質問2: 「今日の体調や気分はいかがでしたか？」

UI: 自由記述入力欄。

処理: 日記的な記録として保存。ユーザーの振り返りに活用。

3.4. ダッシュボード（進捗トラッキング・取り戻し状況統合表示）
ダッシュボードの統合設計:

メインダッシュボードに進捗トラッキング機能を統合し、一画面でチャレンジの全体状況を把握できるようにする。

別途進捗専用ページは設けず、ダッシュボードがメインの進捗確認画面として機能する。

ヘッダーナビゲーションから記録履歴セクションへの直接アクセス機能を提供し、ユーザーが迅速に過去の記録を確認できるようにする。

進捗表示:

30日間の禁煙チャレンジの残り日数や達成状況を視覚的に表示（例: プログレスバー、カレンダー形式で記録日を表示）。

「記録成功日数 / 30日」と「達成率: X%」を明確に表示。

詳細カレンダー: 30日間のカレンダー形式で、各日の記録状況（禁煙成功・喫煙・未記録・未来）を色分けして表示。カレンダーには実際の日付（MM/DD形式）を表示し、チャレンジ開始日から終了日までの実際の期間が一目でわかるようにする。

取り戻し状況表示:

「現在、〇〇円を取り戻し予定」のように、ユーザーの達成率に基づいて返金される予定の金額をリアルタイムで表示。

計算式: 参加費 × (記録成功日数 / 30)

ナラティブ要素の連携:

ダッシュボードでマネーモンスターのビジュアルを表示し、取り戻した金額に応じてモンスターの姿や、モンスターが持つ財産の量が変化する演出。

- マネーモンスターの体力表示形式: 「現在の体力/最大体力」（例：¥8,000 / ¥10,000）
  - 最大体力: 初期の参加費（マネーモンスターが最初に奪った金額）
  - 現在の体力: まだ奪われている金額（残りの金額）
  - 体力ゲージ: 現在の体力に応じて視覚的に減少

統計情報の詳細表示: 現在の成功率、記録成功日数、未記録日数、記録履歴などを一元表示。

3.5. 通知機能
ユーザーが設定した記録時間になったら、記録を促すプッシュ通知。

3.6. お問い合わせ機能 (Contact Support Feature)
ユーザーがアプリの使用中に疑問や問題が発生した場合に、運営側に直接問い合わせができる機能を実装する。

お問い合わせフォームの構成:
- 件名の選択（プルダウン形式）
  - 「使い方について」
  - 「技術的な問題」
  - 「決済・返金について」
  - 「その他」
- 問い合わせ内容（自由記述、必須項目）
- 送信者情報は自動的にログインユーザーの情報を使用

送信先・処理:
- 送信先メールアドレス: yabaichemistryteacher@gmail.com
- 送信者のメールアドレス、件名、問い合わせ内容を含むメールを自動送信
- 送信後は確認メッセージを表示し、フォームをリセット

UI/UX:
- 設定画面内の「サポート」または「お問い合わせ」セクションに配置
- シンプルで使いやすいフォームデザイン
- 送信中はローディング状態を表示
- エラー時は適切なエラーメッセージを表示

技術実装:
- Next.js Server Actionを使用してメール送信処理を実装
- 入力値の検証（バリデーション）を実装
- スパム対策として送信頻度制限を検討

3.7. ゲーム終了時の処理 (Game Completion Feature)
30日間のチャレンジが完了した時点（30日カレンダーが全て埋まった時点）でのゲーム終了処理を実装する。

ゲーム終了の判定:
- 30日間の経過（start_dateから30日後の日付が終了した場合）
- OR 最終日の記録をしたとき
- チャレンジのstatusが'completed'に更新される

結果発表画面の内容:
1. **チャレンジ完了メッセージ**:
   - 「30日間のチャレンジが完了しました！お疲れ様でした！」

2. **マネーモンスターとの戦いの結果**:
   - achievementRateが100%の場合: 「完全勝利！マネーモンスターを完全に倒しました！」
   - achievementRateが75%以上の場合: 「大勝利！マネーモンスターに大ダメージを与えました！」
   - achievementRateが50%以上の場合: 「勝利！マネーモンスターとの戦いに勝ちました！」
   - achievementRateが25%以上の場合: 「健闘！記録を続けた努力は素晴らしいです！」
   - achievementRateが25%未満の場合: 「チャレンジ参加ありがとうございました。次回はきっと良い結果になります！」

3. **具体的な数値結果**:
   - 記録成功日数: 「30日中○○日記録を続けました」
   - 達成率: 「達成率○○%」
   - 取り戻した金額: 「¥○○,○○○を取り戻しました」

4. **次のアクションの選択肢**:
   - **「もう一度チャレンジする」ボタン**:
     - 新しい30日チャレンジを開始
     - オンボーディング画面にリダイレクト（設定を見直す機会を提供）
     - 前回の設定を引き継ぐオプションも提供
   
   - **「今回は終了する」ボタン**:
     - ダッシュボードに戻る
     - 「チャレンジ履歴」として過去の結果を確認できる状態にする
     - いつでも新しいチャレンジを開始できることを案内

UI/UX設計:
- ゲーム終了時には、ポップアップで結果発表とアクション選択のUIを表示する。
- ポップアップの内容は以下の通りとする：
  - **チャレンジ完了メッセージ**: 「30日間のチャレンジが完了しました！お疲れ様でした！」
  - **マネーモンスターとの戦いの結果**: 達成率に応じたメッセージを表示（例: 「完全勝利！マネーモンスターを完全に倒しました！」）
  - **具体的な数値結果**:
    - 記録成功日数: 「30日中○○日記録を続けました」
    - 達成率: 「達成率○○%」
    - 取り戻した金額: 「¥○○,○○○を取り戻しました」
  - **次のアクションの選択肢**:
    - 「もう一度チャレンジする」ボタン
    - 「今回は終了する」ボタン
  - **注意書き**: 「返金には数日かかる恐れがあります。」
- ポップアップにはアニメーション効果を適用し、結果発表を盛り上げる。
- ポップアップ内のボタンは目立つデザインとし、ユーザーが次のアクションを容易に選択できるようにする。

技術実装:
- MoneyMonsterPropsに`isGameCompleted`プロパティを追加
- `onRestartChallenge`と`onFinishChallenge`のコールバック関数を追加
- ダッシュボードから適切なコールバック関数を渡す
- 新しいチャレンジ開始時は既存のチャレンジをcompletedに更新してから新規作成

4. 技術スタック
プラットフォーム: Webアプリケーション

フロントエンド: Next.js (React)

バックエンド/データベース/認証: Supabase
- 認証: Supabase Auth（メール認証 + Google OAuth）
- データベース: PostgreSQL
- リアルタイム機能: Supabase Realtime

決済: Stripe (参加費の徴収・返金処理)

5. 決済フローと収益モデル
参加費徴収:

オンボーディング時に、設定された参加費を徴収する。

- 参加費が1円以上の場合: Stripe CheckoutまたはElementsを利用して一括で徴収
- 参加費が0円の場合: 決済処理はスキップし、30日間のチャレンジを開始

返金実施:

チャレンジ終了時（30日後）、その時点での記録成功日数に応じて以下を実施:

返金選択ユーザー: 
  - 返金額の計算式: 参加費 × (記録成功日数 / 30)
  - 返金額が1円以上の場合のみ、Stripe経由で返金処理を実行

収益の計上:

返金選択ユーザーからの収益: 参加費から返金されなかった残りの部分
  - 計算式: 参加費 × (1 - 記録成功日数 / 30)

この収益が、アプリの運営費や将来的な機能拡張のための資金となる。

6. その他検討事項
ユーザーサポート: 問い合わせ対応方法。

法規制:

特定商取引法に基づく表記、プライバシーポリシー、利用規約の整備。
- 特定商取引法に基づく表記ページを設置し、そのページへのリンクを設定画面の「サポート」または「法的情報」セクションに配置する。

金銭が絡むため、資金決済法などの関連法規の確認（必要に応じて弁ｓｓ護士などの専門家へ相談）。

返金処理に関する規約の整備。

セキュリティ: ユーザーの個人情報や決済情報を取り扱うため、StripeやSupabaseのセキュリティ機能を最大限活用し、APIキー管理など自社で実装する部分も厳重に管理。

7. 今後の拡張性
返金プラン機能の拡張:
- ユーザーの進捗状況や選択プランに応じた、ダッシュボードでの返金予測額の表示
- プラン変更機能の検討（プログラム途中での変更可否、条件など）
- プランごとのユーザー行動データ分析
- 不正防止については、ユーザーの信頼を前提とし、現時点では特別な対策は行わない